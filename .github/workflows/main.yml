name: Build and publish

on: [push, pull_request]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

    #steps:
      - uses: actions/cache@v2
        id: cache
        with:
          path: |
            C:\downloads\opencv-4.5.1
            C:\Qt
          key: ${{ runner.os }}-${{ hashFiles('**/lockfiles') }}

      # Todo: use store for packed libs to save time on decompression
      - name: Download Precompiled OpenCV 4.5.1 libs
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mkdir C:\downloads
          pip install gdown
          gdown --id 1D0Op3M9LMxfDmjgsomGhki4hTAm4FKof --output C:\downloads\opencv-4.5.1.7z
          7z -r x C:\downloads\opencv-4.5.1.7z -oc:\downloads\
          echo OpenCV_DIR="C:\downloads\opencv-4.5.1" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append

      - name: Install Qt
        if: steps.cache.outputs.cache-hit != 'true'
        uses: jurplel/install-qt-action@v2
        with:
          version:      '5.15.2'
          arch:         'win64_mingw81'
          dir:          'C:'
          tools:        'tools_ifw,4.1.1,qt.tools.ifw.41 tools_qtcreator,5.0.2-0,qt.tools.qtcreator,qt.tools.'

      - name: Add Qt to environment variable
        run: |
          echo Qt_Install="C:\Qt" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append

      - name: Build Trdrop
        run: |
          qmake.exe        -o Makefile trdrop\trdrop.pro -spec win32-g++ "CONFIG+=qtquickcompiler"
          mingw32-make.exe -f Makefile.Release

      # Todo: cleanup release folder for less bloat
      - name: Package trdrop for artifact
        run: |
          copy-item $env:OpenCV_DIR\build_64\install\x64\mingw\bin\*.dll $env:GITHUB_WORKSPACE\release
          copy-item C:\msys64\mingw64\bin\*.dll $env:GITHUB_WORKSPACE\release
          windeployqt.exe --qmldir $env:GITHUB_WORKSPACE $env:GITHUB_WORKSPACE\release

      - name: Cleanup for packaging
        run: |
          remove-item $env:GITHUB_WORKSPACE\release\* -include *.cpp, *.c, *.o, *.h -exclude *.exe, *.dll
